{% extends "base.html" %}

{% block content %}
<div class="container py-5 bg-white min-vh-100">
  <div class="text-center mb-5">
    <h1 style="font-weight: 600; color: #333;">Meet Your Perfect Study Partners</h1>
    <p class="text-muted">Start chatting with you perfect match!</p>
  </div>

  {% if matches %}
    {% set pieColors = ['#aacde4', '#c6dabf', '#ffd8a9', '#f7c5cc', '#cccccc', '#b5d0ea', '#d4c3e8', '#e0e1da'] %}
    <div class="row g-5 align-items-start">
      <div class="col-lg-6">
        <div class="card p-4 border-0" style="border-radius: 1rem; background-color: #f9f9f9;">
<div class="table-responsive">
  <table class="table align-middle text-center mb-0" style="border-collapse: separate; border-spacing: 0 10px;" aria-label="Matches Table">
    <thead class="table-light">
      <tr>
        <th scope="col" style="font-weight: 600;">Name</th>
        <th scope="col" style="font-weight: 600;">Match %</th>
      </tr>
    </thead>
    <tbody>
      {% for match in matches %}
      <tr class="clickable-row"
          style="background-color: {{ pieColors[loop.index0 % pieColors|length] }}; cursor: pointer; position: relative; transition: opacity 0.3s ease;">
        <td class="py-3">{{ match.name }}</td>
        <td class="text-muted py-3">{{ (match.score * 100) | round(2) }}%</td>
      </tr>
      <tr class="dropdown-content" style="display: none;">
        <td colspan="2" class="p-3">
            <!-- Change to redirect to messages route with the match_user_id -->
            <a href="{{ url_for('messages', user_id=match.match_user_id) }}" class="btn btn-primary w-100 rounded-3">
            Start Chatting
            </a>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.clickable-row').forEach(row => {
      row.addEventListener('click', function () {
        const dropdown = this.nextElementSibling;
        if (dropdown && dropdown.classList.contains('dropdown-content')) {
          dropdown.style.display = dropdown.style.display === 'none' ? 'table-row' : 'none';
        }
      });
    });
  });
</script>
        </div>
      </div>

      <!-- Bar Chart -->
      <div class="col-lg-6">
        <div class="card p-4 border-0 d-flex flex-column align-items-center justify-content-center" style="border-radius: 1rem; background-color: #f9f9f9;">
          <h5 class="mb-4 text-muted" style="font-weight: 500;">Match Distribution</h5>
          <div style="width: 100%; height: 300px; position: relative;">
            <canvas id="matchPieChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  {% else %}
    <div class="alert alert-info text-center mt-5 rounded-4 shadow-sm">
      No matches found. Try updating your preferences!
    </div>
  {% endif %}

  <div class="d-flex justify-content-center mt-5">
    <a href="{{ url_for('edit_preferences') }}" class="btn btn-primary btn-lg rounded-pill px-5">
      Edit Preferences
    </a>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

{% if matches %}
<script>
  const ctx = document.getElementById('matchPieChart').getContext('2d');
  const pieColors = ['#aacde4', '#c6dabf', '#ffd8a9', '#f7c5cc', '#cccccc', '#b5d0ea', '#d4c3e8', '#e0e1da'];

  const matchBarChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: [{% for match in matches %}"{{ match.name }}"{% if not loop.last %}, {% endif %}{% endfor %}],
      datasets: [{
        label: 'Match Percentage',
        data: [{% for match in matches %}{{ (match.score * 100) | round(2) }}{% if not loop.last %}, {% endif %}{% endfor %}],
        backgroundColor: pieColors.slice(0, {{ matches|length }}),
        borderColor: '#fff',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Match Percentage (%)'
          }
        },
        x: {
          title: {
            display: true,
            text: 'Study Partners'
          }
        }
      },
      plugins: {
        legend: {
          display: false
        }
      }
    }
  });
</script>
{% endif %}

<!-- Expand/Collapse JS -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.clickable-row').forEach(row => {
      row.addEventListener('mouseover', () => {
        row.style.opacity = "0.85";
      });
      row.addEventListener('mouseout', () => {
        row.style.opacity = "1";
      });

      row.addEventListener('click', function () {
        const href = this.getAttribute('data-href');
        if (href) {
          window.location.href = href;
        }
      });
    });
  });
</script>
{% endblock %}